
<h1>MIDI</h1>

<p>Test MIDI()</p>

<script src="js/midi.js"></script>
<script src="../midi-filter/js/midi-filter.js"></script>
<script src="../midi-modify/js/midi-modify.js"></script>
<script>
	MIDI.register('filter', MIDIFilter);
	MIDI.register('modify', MIDIModify);

	console.group('Testing MIDI...');

	function testMessage(message) {
		console.assert(!!message, 'No message passed in.');
		console.assert(!!message.data, 'Message must have data.');
	}


	console.log('Testing .in() and .out()');

	(function() {
		var count = 0;

		function increment() { count++; }

		MIDI().out(increment);

		console.assert(count === 0, '.out() should be called 0 times.');
	})();

	(function() {
		var count = 0;

		function increment() {
			count++;
		}

		MIDI()
		.out(increment)
		.in({ data:[144,40,40] });

		console.assert(count === 1, '.out() should be called 1 time.');
	})();

	(function() {
		var count = 0;

		function increment() { count++; }

		MIDI()
		.out(increment)
		.in({ data:[144,40,40] })
		.in({ data:[148,80,20] });

		console.assert(count === 2, '.out() should be called 2 times.');
	})();

	(function() {
		var count = 0;

		function increment() { count++; }

		MIDI()
		.out(increment)
		.out(increment)
		.in({ data:[144,40,40] })
		.in({ data:[148,80,20] });

		console.assert(count === 4, '.out() should be called 4 times.');
	})();

	(function() {
		var count = 0;

		function increment() { count++; }

		MIDI()
		.out(increment)
		.out(increment)
		.out(increment)
		.in({ data:[144,40,40] })
		.in({ data:[148,80,20] });

		console.assert(count === 6, '.out() should be called 6 times.');
	})();

	(function() {
		var count = 0;

		function increment() { count++; }

		MIDI()
		.out(testMessage)
		.out(testMessage)
		.out(testMessage)
		.in({ data:[144,40,40] })
		.in({ data:[148,80,20] });
	})();


	console.log('Testing midi.log()');

	(function() {
		var count = 0;

		function increment() { count++; }

		MIDI()
		.out(increment)
		.log()
		.out(increment)
		.in({ data:[144,40,40] });

		console.assert(count === 2,
		              '.out() should be called twice.');
	})();


	console.log('Testing midi.input()');

	(function() {
		var count = 0;

		function increment() { count++; }

		MIDI()
		.input()
		.log()
		.in({ data:[144,40,40] });
	})();

	(function() {
		var count = 0;

		function increment() { count++; }

		MIDI()
		.input('Port 1')
		.output('Bus 1')
		.in({ data:[144,40,40] });
	})();


	console.log('Testing midi.filter()');

	(function() {
		var count = 0;

		function increment() { count++; }

		MIDI()
		.out(increment)
		.filter({ message: 'pitch' })
		.out(increment)
		.in({ data:[144,40,40] });

		console.assert(count === 1,
		              'Only the first out in the chain should have been called.');
	})();


	console.log('Testing midi.modify()');

	(function() {
		MIDI()
		.modify({ message: 'noteoff' })
		.out(function(e) {
			console.assert(e.data[0] === 134, 'data[0] should be 134');
			console.assert(e.message === undefined || e.message === 'noteoff',
			              'Message should be noteoff');
		})
		.in({ data:[150,40,40], message: 'noteon' });
	})();

	(function() {
		MIDI()
		.modify({ message: 'pitch' })
		.out(function(e) {
			console.assert(e.data[0] === 230, 'data[0] should be 134', e.data[0]);
			console.assert(e.message === undefined || e.message === 'pitch',
			              'Message should be pitch', e.message);
		})
		.in({ data:[150,40,40], message: 'noteon' });
	})();

	(function() {
		MIDI()
		.modify({ port: 'Port 2' })
		.out(function(e) {
			console.assert(e.port === 'Port 2',
			              'e.port should be Port 2', e.port);
		})
		.in({ data:[150,40,40] });
	})();

	(function() {
		MIDI()
		.modify({ data1: 0 })
		.out(function(e) {
			console.assert(e.data[1] === 0,
			              'e.data[1] should be 0', e.data[1]);
		})
		.in({ data:[150,40,40] });
	})();

	(function() {
		MIDI()
		.modify({ data2: 127 })
		.out(function(e) {
			console.assert(e.data[2] === 127,
			              'e.data[2] should be 127', e.data[2]);
		})
		.in({ data:[150,40,40] });
	})();

	console.log('...tests complete');
	console.groupEnd()

</script>

