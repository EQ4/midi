!function(a){"use strict";function b(){}function c(a){return this.send=a,this.out=d,this}function d(a){var b=[this.send,a];return Object.defineProperty(this,"listeners",{value:b}),this.out=e,delete this.send,this}function e(a){return this.listeners.push(a),this}function f(a){if(this.listeners){for(var b=this.listeners.length,c=-1;++c<b;)this.listeners[c](a);return this}}function g(){this.send.apply(this,arguments)}function h(a){return Object.create(q,{"in":{value:a||g,enumerable:!0}})}function i(){var a=h(b);return a}function j(a){var c=h(a);return c.out=b,c}function k(a){return function(b){var c=a(b);return this.out(c.in),c}}function k(a,c){return function(a){var d=c(a);return this.out(d.in.bind(d)),d.out!==b&&(this.out=function(a){return d.out(a),this}),this}}function l(a,b){q[a]=k(a,b)}function m(a){console.warn(a)}function n(a){return navigator.requestMIDIAccess?navigator.requestMIDIAccess().then(a,m):void(p||alert("Your browser does not support MIDI via the navigator.requestMIDIAccess() API."))}function o(){return o.Node()}var p=!1,q={out:c,send:f};o.noop=b,o.request=n,o.register=l,o.Node=h,o.Source=i,o.Destination=j,a.MIDI=o}(window),function(a){"use strict";function b(a,b){var c=Math.pow(10,b);return Math.round(a*c)/c}function c(a){return a[0]>127&&a[0]<160}function d(a){return a[0]>175&&a[0]<192}function e(a){return a[0]>223&&a[0]<240}function f(a){return a[0]%16+1}function g(b){var c=a.messages[Math.floor(b[0]/16)-8];return c===a.messages[1]&&0===b[2]?a.messages[0]:c}function h(a){return 0===a[2]&&a[0]>143&&a[0]<160&&(a[0]-=16),a}function i(a){return a[0]>127&&a[0]<144&&(a[0]+=16,a[2]=0),a}function j(a){return(a[2]<<7|a[1])-8192}function k(a,b){return(void 0===b?2:b)*j(a)/8191}function l(a){var b=rnote.exec(a);return 12*parseInt(b[2])+q[b[1]]}function m(a){return p[a%12]}function n(b){return Math.floor(b/12)-(5-a.middle)}function o(c){return b(a.pitch*Math.pow(1.059463094359,c+3-12*(a.middle+2)))}var p=["C","C♯","D","E♭","E","F","F♯","G♯","A","B♭","B"],q={C:0,"C♯":1,"D♭":1,D:2,"D♯":3,"E♭":3,E:4,F:5,"F♯":6,"G♭":6,G:7,"G♯":8,"A♭":8,A:9,"A♯":10,"B♭":10,B:11};a.messages=["noteoff","noteon","polytouch","cc","pc","channeltouch","pitch"],a.pitch=440,a.middle=3,a.isNote=c,a.isPitch=e,a.isControl=d,a.noteToNumber=l,a.numberToNote=m,a.numberToOctave=n,a.numberToFrequency=o,a.channel=f,a.message=g,a.normaliseNoteOn=i,a.normaliseNoteOff=h,a.pitchToInt=j,a.pitchToFloat=k}(MIDI),function(a){"use strict";function b(a){var b;for(b in a)delete a[b]}function c(a){g[a.name]=a}function d(a){b(g),a.inputs().forEach(c)}function e(b){b.addEventListener("connect",function(){d(b)}),b.addEventListener("disconnect",function(){d(b)}),d(b),e=a.noop}function f(b){function c(a){f.send(a)}function d(a){a.addEventListener("midimessage",c)}var f=a.Source();return a.request(function(a){e(a),b&&b.port?d(g[b.port]):a.inputs().forEach(d)}),f}var g={};a.Input=f,a.register("input",a.Input)}(MIDI),function(){"use strict";function a(a,b){for(var c,d=a.length;d--;)if(c=a[d],c.name===b||c.id===b||c===b)return a[d];console.log("MIDI port '"+b+"' not found")}function b(b){var d,e=MIDI.Destination(function(a){d&&(c&&console.log(a.data,"output"),d.send(a.data,a.time))});return MIDI.request(function(c){d=b?a(c.outputs(),b):c.outputs()[0]}),e}var c=!0;MIDI.Output=b,MIDI.register("output",b)}(),function(a){"use strict";function b(b){return a.Node(function(d){{var e;d.data}for(e in b)if(c[e]&&!c[e](d,b[e]))return void(b.reject&&b.reject(d));d.channel=d.channel||a.channel(d.data),d.message=d.message||a.message(d.data),this.send(d)})}var c=(a.messages,{port:function(a,b){return a.target?"number"==typeof b?b===a.target.id:"string"==typeof b?b===a.target.name:b===a.target:!1},channel:function(b,c){return void 0===b.channel&&(b.channel=a.channel(b.data)),"number"==typeof c?c===b.channel:c(b.channel)},message:function(b,c){return void 0===b.message&&(b.message=a.message(b.data)),"string"==typeof c?c===b.message:"[object RegExp]"===Object.prototype.toString.apply(c)?c.test(b.message):c(b.message)},data1:function(a,b){return"number"==typeof b?b===a.data[1]:b(a.data[1])},data2:function(a,b){return"number"==typeof b?b===a.data[2]:b(a.data[2])}});a.Filter=b,a.register("filter",b)}(MIDI),function(a){"use strict";function b(a){"noteon"===a.message&&0===a.data[2]&&(a.data[0]+=-16,a.message=e[0])}function c(a,c){var d;for(d in c)f[d]&&f[d](a,c[d]);b(a)}function d(b){return a.Node(function(a){c(a,b),this.send(a)})}var e=a.messages,f={port:function(a,b){a.port=b},channel:function(b,c){var d=a.channel(b.data);if("number"!=typeof c&&(c=c(d)),1>c||c>16)throw new Error("Cannot change channel to "+c);b.data[0]=b.data[0]-d+c,b.channel=c},message:function(a,b){var c=e.indexOf(b);if(-1===c)throw new Error("Cannot change message to '"+b+"'");a.data[0]=16*(c+8)+a.data[0]%16,a.message=b},data1:function(a,b){"number"!=typeof b&&(b=b(data[1])),0>b?b=0:b>127&&(b=127),a.data[1]=b},data2:function(a,b){"number"!=typeof b&&(b=b(data[2])),0>b?b=0:b>127&&(b=127),a.data[2]=b}};a.Modify=d,a.register("modify",d)}(MIDI),function(a){"use strict";function b(a){return void 0!==a&&null!==a}function c(a,c){var d=a[c[0]]||(a[c[0]]=[]),f=d[c[1]];b(f)||(f=0),f+=e.data[2]-63,f=0>f?0:f>127?127:f,e.data[2]=d[c[1]]=f}function d(b){b=Sparky.extend({},f,b);var d=a.Filter(b),e=a.Node(function(a){d.in(a)}),g={};return b.reject=function(a){e.send(a)},"continuous"===b.type&&d.out(function(a){c(g,a),e.send(a)}),e}var f={};a.Convert=d,a.register("convert",d)}(MIDI),function(a){"use strict";function b(a){return a[0]>127&&a[0]<160}function c(a){return a[0]>175&&a[0]<192}function d(a){return a[0]>223&&a[0]<240}function e(a){return(a[2]<<7|a[1])-8192}function f(a,b){return b*e(a)/8191}function g(a){return a[0]%16+1}function h(){return window.performance.now()}function i(a,b,c,d){return["hsla(",a,",",b,"%,",c,"%,",d,")"].join("")}function j(a,b){a.clearRect(0,0,b.width,b.height)}function k(a,b){a.setTransform(b.innerWidth/(128*b.xblock),0,0,b.innerHeight/127,b.paddingLeft,b.paddingTop),a.lineJoin="round",a.lineCap="round"}function l(a,b){a.save(),a.lineWidth=2,a.strokeStyle=b.gridColor1,a.beginPath(),a.moveTo(0,b.paddingTop+1),a.lineTo(b.width,b.paddingTop+1),a.stroke(),a.closePath(),a.lineWidth=2,a.strokeStyle=b.gridColor2,a.beginPath(),a.moveTo(0,b.paddingTop+b.innerHeight/2),a.lineTo(b.width,b.paddingTop+b.innerHeight/2),a.stroke(),a.closePath(),a.restore()}function m(a,b,c){var d=i.apply(this,b.colors[c]);a.fillStyle=d,a.strokeStyle=d}function n(a,b,c,d){a.lineWidth=6*b.xunit,a.fillRect(3*b.xunit+c*b.xblock,127-d,6*b.xunit,d),a.strokeRect(3*b.xunit+c*b.xblock,127-d,6*b.xunit,d)}function o(a,b,c,d,e){var f=3*b.xunit+c*b.xblock,g=9*b.xunit+c*b.xblock;a.lineWidth=6*b.xunit,a.beginPath(),a.moveTo(f,127),a.bezierCurveTo(f,127-.12*d,f,127-.4*d,3*b.xunit+(c+e)*b.xblock,127-d),a.lineTo(9*b.xunit+(c+e)*b.xblock,127-d+e/6),a.bezierCurveTo(g,127-.4*d,g,127-.12*d,g,127),a.fill(),a.stroke(),a.closePath()}function p(a,b,c,d,e){return e?o(a,b,c,d,e):n(a,b,c,d)}function q(a,b,c,d,e){var f=6*b.xunit+c*b.xblock;a.save(),a.strokeStyle=e,a.lineWidth=4*b.xunit,a.beginPath(),a.moveTo(f,127),a.lineTo(f,130-d),a.arc(f,127-d,3,.5*Math.PI,2.5*Math.PI,!1),a.stroke(),a.closePath(),a.restore()}function r(b,c,d,e){var f,g;for(m(b,c,d),f=e.ccs,g=f.length;g--;)f[g]!==a&&q(b,c,g,f[g].data[2],f[g].color);for(f=e.notesRender,g=f.length;g--;)f[g]&&p(b,c,g,f[g],e.pitch)}function s(a,b,c){var d=16;for(a.save(),j(a,b),l(a,b),k(a,b);d--;)r(a,b,d,c[d]);a.restore()}function t(a){return parseInt(a,10)}function u(a){return D.exec(a).splice(1,3).map(t)}function v(b,c){var d=(b.paddingLeft||B.paddingLeft)*c.width,e=(b.paddingRight||B.paddingRight)*c.width,f=(b.paddingTop||B.paddingTop)*c.height,g=c.width-d-e,h=c.height-f;if(b.colors)for(var i=b.colors.map(u),j=i.length;j--;)i[j]===a?i[j]=C[j]:i[j].push(1);return{width:c.width,height:c.height,paddingLeft:d,paddingRight:e,paddingTop:f,innerWidth:g,innerHeight:h,gridColor1:b.gridColor1||B.gridColor1,gridColor2:b.gridColor2||B.gridColor2,xblock:g/h,xunit:128/h,colors:i||C}}function w(a,b){var c=g(b)-1,d=a[c].notesRender,e=a[c].notes,f=d[b[1]]||0,h=e[b[1]];return f===h?!1:(d[b[1]]=2>h-f?h:f+(h-f)*B.ease,!0)}function x(a,b,c,d){var e=g(c.data)-1,f=b.colors[e],h=(B.fadeDuration-d+c.time)/B.fadeDuration;return 0>h?!1:(c.color=i(f[0],f[1]*h,f[2],f[3]*(B.fadeLimit+(1-B.fadeLimit)*h)),!0)}function y(a,b){a[g(b)-1].notes[b[1]]=b[0]<144?0:b[2]}function z(a,b){var c=a[g(b)-1].ccs[b[1]];c||(c={},a[g(b)-1].ccs[b[1]]=c),c.data=b,c.time=h()}function A(a){function e(a){var b,c,d=16;for(o=!1,b=m.length;b--;)w(l,m[b])?h():m.splice(b,1);for(;d--;)for(b=l[d].ccs.length;b--;)c=l[d].ccs[b],c&&x(l,k,c,a)&&h();s(j,k,l)}function h(){o!==!0&&(window.requestAnimationFrame(e),o=!0)}var i="string"==typeof a.canvas?document.querySelector(a.canvas):a.canvas;if(!i.getContext)throw new Error("options.node must contain a canvas element.");for(var j=i.getContext("2d"),k=v(a,i),l=[],m=[],n=16,o=!1;n--;)l[n]={notesRender:[],notes:[],ccs:[],pitch:0};return MIDI.Destination(function(i){return b(i.data)?(m.push(i.data),y(l,i.data,h),void h(e)):c(i.data)?(z(l,i.data),void h(e)):d(i.data)?(l[g(i.data)-1].pitch=f(i.data,a.range||2),void h(e)):void 0})}var B={paddingLeft:1/30,paddingRight:1/30,paddingTop:.125,ease:.6667,fadeDuration:6e3,fadeLimit:.24,gridColor1:"hsla(0, 0%, 60%, 0.24)",gridColor2:"hsla(0, 0%, 40%, 0.12)"},C=[[220,56,68,1],[232,57,66,1],[244,58,65,1],[256,60,62,1],[268,60,62,1],[280,61,61,1],[292,62,61,1],[304,58,60,1],[316,62,62,1],[328,64,62,1],[340,66,62,1],[352,68,62,1],[4,71,61,1],[16,74,61,1],[28,77,61,1],[40,80,60,1]],D=/^(?:hsl\()?\s?(\d{1,3}(?:\.\d+)?)\s?,\s?(\d{1,3}(?:\.\d+)?)%\s?,\s?(\d{1,3}(?:\.\d+)?)%\s?\)?$/;MIDI.Graph=A,MIDI.Graph.defaults=B,MIDI.register("graph",MIDI.Graph)}(),function(a){"use strict";function b(){return window.performance.now()}function c(b,c){b[a.channel(c)-1].notes[c[1]]=c[0]<144?0:c[2]}function d(c,d){var e=c[a.channel(d)-1].ccs[d[1]];e||(e={},c[a.channel(d)-1].ccs[d[1]]=e),e.data=d,e.time=b()}function e(b){var e=[],j=16;for(b=b||a.noop;j--;)e[j]={notes:[],ccs:[],pitch:0};return b(e),a.Destination(function(b){return g(b.data)?void c(e,b.data):h(b.data)?void d(e,b.data):i(b.data)?void(e[a.channel(b.data)-1].pitch=a.pitchToFloat(b.data,f.range||2)):void 0})}var f={range:2},g=a.isNote,h=a.isControl,i=a.isPitch;a.OutMap=e,a.OutMap.defaults=f,a.register("outMap",a.OutMap)}(MIDI),function(a){"use strict";function b(a){return a/127}function c(c){var d=a.Destination(function(d){var e=a.message(d.data);return c(e===a.messages[6]?[d.receivedTime,e,a.pitchToFloat(d.data)]:[d.receivedTime,e,d.data[1],b(d.data[2])])});return d}a.OutArray=c,a.register("outArray",c)}(MIDI),function(a){"use strict";function b(){return a.Destination(function(a){console.log(a.data)})}a.Log=b,a.register("log",b)}(MIDI);